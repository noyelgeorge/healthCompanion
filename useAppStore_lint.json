[{"filePath":"D:\\NOYEL\\pwa_food\\pwa_food\\pwa\\src\\store\\useAppStore.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'newStreaks' is never reassigned. Use 'const' instead.","line":225,"column":21,"nodeType":"Identifier","messageId":"useConst","endLine":225,"endColumn":31,"fix":{"range":[7542,7579],"text":"const newStreaks = { ...state.streaks }"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":509,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":509,"endColumn":31}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { create } from 'zustand'\r\nimport { persist, createJSONStorage } from 'zustand/middleware'\r\nimport { auth, db } from '../lib/firebase'\r\nimport { onAuthStateChanged, signOut } from 'firebase/auth'\r\nimport { doc, setDoc, getDoc, collection, getDocs, deleteDoc, addDoc } from 'firebase/firestore'\r\nimport { type RecipeBookItem, addToRecipeBook as firestoreAddRecipe, getRecipeBook as firestoreGetRecipes, removeFromRecipeBook as firestoreRemoveRecipe } from '../services/social'\r\n\r\n\r\n\r\nexport type Gender = 'male' | 'female' | 'other'\r\nexport type ActivityLevel = 'sedentary' | 'light' | 'moderate' | 'active' | 'athlete'\r\nexport type Goal = 'lose' | 'maintain' | 'gain'\r\n\r\nexport interface UserProfile {\r\n    isAuthenticated: boolean\r\n    uid?: string\r\n    name: string\r\n    email: string // Added email\r\n    phoneNumber?: string // Added phone number for WhatsApp reminders\r\n    height: number // cm\r\n    weight: number // kg\r\n    age: number\r\n    gender: Gender\r\n    activityLevel: ActivityLevel\r\n    goal: Goal\r\n    onboardingCompleted: boolean\r\n    photoURL?: string\r\n    waterGoal: number // ml\r\n}\r\n\r\nexport interface MealEntry {\r\n    id: string\r\n    mealType: 'breakfast' | 'lunch' | 'dinner' | 'snack'\r\n    name: string\r\n    calories: number\r\n    protein: number\r\n    carbs: number\r\n    fat: number\r\n    ingredients?: string[] // Added for shopping list\r\n    healthScore?: number   // v2.2\r\n    reasoning?: string     // v2.2\r\n    timestamp: number\r\n}\r\n\r\nexport interface DayLog {\r\n    date: string // YYYY-MM-DD\r\n    entries: MealEntry[]\r\n    waterIntake: number // ml\r\n}\r\n\r\nexport interface DayPlan {\r\n    date: string\r\n    entries: MealEntry[]\r\n    totalCalories: number\r\n}\r\n\r\nexport type ExerciseType = 'walk' | 'run' | 'bike' | 'strength' | 'yoga' | 'other'\r\n\r\nexport interface ExerciseEntry {\r\n    id: string\r\n    name: string\r\n    type: ExerciseType\r\n    durationMinutes: number\r\n    intensity: 'low' | 'moderate' | 'high'\r\n    calories?: number\r\n    timestamp: number\r\n}\r\n\r\nexport interface DayExerciseLog {\r\n    date: string\r\n    entries: ExerciseEntry[]\r\n}\r\n\r\nexport interface Reminder {\r\n    id: string\r\n    medicineName: string\r\n    time: string\r\n    notes: string\r\n    enabled: boolean\r\n    phoneNumber?: string\r\n    createdAt: number\r\n}\r\n\r\nexport interface WeightEntry {\r\n    date: string\r\n    weight: number\r\n    timestamp: number\r\n}\r\n\r\n\r\n\r\n\r\ninterface AppState {\r\n    user: UserProfile\r\n    logs: Record<string, DayLog> // key is YYYY-MM-DD\r\n    plans: Record<string, DayPlan>\r\n    exerciseLogs: Record<string, DayExerciseLog>\r\n    recipeBook: RecipeBookItem[]\r\n    reminders: Reminder[]\r\n    medicineMode: boolean\r\n    weightHistory: WeightEntry[]\r\n\r\n\r\n\r\n    streaks: {\r\n        current: number\r\n        longest: number\r\n        lastLoggedDate?: string\r\n    }\r\n\r\n    apiKey: string | null // Personal key\r\n    sharedApiKey: string | null // Global shared key from owner\r\n    theme: 'light' | 'dark' | 'system'\r\n    lastSyncedAt: string | null // ISO string of last successful cloud sync\r\n\r\n    // Actions\r\n    login: () => void\r\n    logout: () => Promise<void>\r\n    setUser: (profile: Partial<UserProfile>) => Promise<void>\r\n    setTheme: (theme: 'light' | 'dark' | 'system') => void\r\n    toggleMedicineMode: () => void\r\n    setApiKey: (key: string | null) => void // New action for API key\r\n    addEntry: (date: string, entry: Omit<MealEntry, 'id' | 'timestamp'>) => Promise<void>\r\n    updateEntry: (date: string, updatedEntry: MealEntry) => Promise<void>\r\n    removeEntry: (date: string, entryId: string) => Promise<void>\r\n    addPlanEntry: (date: string, entry: Omit<MealEntry, 'id' | 'timestamp'>) => Promise<void>\r\n    updatePlanEntry: (date: string, updatedEntry: MealEntry) => Promise<void>\r\n    removePlanEntry: (date: string, entryId: string) => Promise<void>\r\n    addExerciseEntry: (date: string, entry: Omit<ExerciseEntry, 'id' | 'timestamp'>) => Promise<void>\r\n    removeExerciseEntry: (date: string, entryId: string) => Promise<void>\r\n    syncWithFirestore: () => Promise<void>\r\n    loadRecipeBook: () => Promise<void>\r\n    addToRecipeBook: (item: Omit<RecipeBookItem, 'id' | 'addedAt'>) => Promise<void>\r\n    removeFromRecipeBook: (id: string) => Promise<void>\r\n    addReminder: (reminder: Omit<Reminder, 'id' | 'createdAt'>) => Promise<void>\r\n    removeReminder: (id: string) => Promise<void>\r\n    clearAllReminders: () => Promise<void>\r\n    updateWaterIntake: (date: string, amount: number) => Promise<void>\r\n    logWeight: (weight: number) => Promise<void>\r\n}\r\n\r\n\r\nexport const useAppStore = create<AppState>()(\r\n    persist(\r\n        (set) => ({\r\n            user: {\r\n                isAuthenticated: false,\r\n                name: 'Guest',\r\n                email: '', // Initial email\r\n                phoneNumber: '', // Initial phone number\r\n                height: 170,\r\n                weight: 70,\r\n                age: 30,\r\n                gender: 'male',\r\n                activityLevel: 'moderate',\r\n                goal: 'maintain',\r\n                onboardingCompleted: false,\r\n                waterGoal: 2000\r\n            },\r\n            logs: {},\r\n            plans: {},\r\n            exerciseLogs: {},\r\n            recipeBook: [],\r\n            reminders: [],\r\n            medicineMode: false,\r\n            weightHistory: [],\r\n\r\n            streaks: {\r\n                current: 0,\r\n                longest: 0\r\n            },\r\n\r\n            apiKey: null,\r\n            sharedApiKey: null,\r\n            theme: 'system',\r\n            lastSyncedAt: null,\r\n\r\n            login: () => set((state) => ({ user: { ...state.user, isAuthenticated: true } })),\r\n            logout: async () => {\r\n                await signOut(auth);\r\n                set((state) => ({ user: { ...state.user, isAuthenticated: false, email: '', uid: undefined } }));\r\n            },\r\n            setUser: async (profile) => {\r\n                set((state) => ({ user: { ...state.user, ...profile } }))\r\n                const latestState = useAppStore.getState()\r\n                if (latestState.user.isAuthenticated && latestState.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', latestState.user.uid!), latestState.user, { merge: true })\r\n                    } catch (e) {\r\n                        console.error(\"Firestore profile sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            setApiKey: (key) => set({ apiKey: key }),\r\n            setTheme: (theme) => set({ theme }),\r\n            toggleMedicineMode: () => set((state) => ({ medicineMode: !state.medicineMode })),\r\n\r\n            addEntry: async (date, entry) => {\r\n                const newEntry: MealEntry = {\r\n                    ...entry,\r\n                    id: crypto.randomUUID(),\r\n                    timestamp: Date.now()\r\n                }\r\n\r\n                const state = useAppStore.getState()\r\n                const existingLog = state.logs[date] || { date, entries: [], waterIntake: 0 }\r\n                const updatedLog = {\r\n                    ...existingLog,\r\n                    entries: [...existingLog.entries, newEntry]\r\n                }\r\n\r\n                set({\r\n                    logs: {\r\n                        ...state.logs,\r\n                        [date]: updatedLog\r\n                    }\r\n                })\r\n\r\n                // Streak Logic\r\n                const yesterday = new Date()\r\n                yesterday.setDate(yesterday.getDate() - 1)\r\n                const yesterdayStr = yesterday.toISOString().split('T')[0]\r\n\r\n                let newStreaks = { ...state.streaks }\r\n                if (state.streaks.lastLoggedDate !== date) {\r\n                    if (state.streaks.lastLoggedDate === yesterdayStr) {\r\n                        newStreaks.current += 1\r\n                    } else if (!state.streaks.lastLoggedDate || state.streaks.lastLoggedDate < yesterdayStr) {\r\n                        newStreaks.current = 1\r\n                    }\r\n                    newStreaks.longest = Math.max(newStreaks.longest, newStreaks.current)\r\n                    newStreaks.lastLoggedDate = date\r\n                    set({ streaks: newStreaks })\r\n\r\n                    // Sync streaks to user profile in firestore\r\n                    if (state.user.isAuthenticated && state.user.uid) {\r\n                        await setDoc(doc(db, 'users', state.user.uid!), { streaks: newStreaks }, { merge: true })\r\n                    }\r\n                }\r\n\r\n                // Firestore Sync\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'logs', date), updatedLog)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            updateEntry: async (date, updatedEntry) => {\r\n                const state = useAppStore.getState()\r\n                const log = state.logs[date]\r\n                if (!log) return\r\n\r\n                const updatedLog = {\r\n                    ...log,\r\n                    entries: log.entries.map(e => e.id === updatedEntry.id ? { ...e, ...updatedEntry } : e)\r\n                }\r\n\r\n                set({\r\n                    logs: {\r\n                        ...state.logs,\r\n                        [date]: updatedLog\r\n                    }\r\n                })\r\n\r\n                // Firestore Sync\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'logs', date), updatedLog)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            removeEntry: async (date, entryId) => {\r\n                const state = useAppStore.getState()\r\n                const log = state.logs[date]\r\n                if (!log) return\r\n\r\n                const updatedLog = {\r\n                    ...log,\r\n                    entries: log.entries.filter(e => e.id !== entryId)\r\n                }\r\n\r\n                set({\r\n                    logs: {\r\n                        ...state.logs,\r\n                        [date]: updatedLog\r\n                    }\r\n                })\r\n\r\n                // Firestore Sync\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'logs', date), updatedLog)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            addPlanEntry: async (date, entry) => {\r\n                const newEntry: MealEntry = {\r\n                    ...entry,\r\n                    id: crypto.randomUUID(),\r\n                    timestamp: Date.now()\r\n                }\r\n\r\n                const state = useAppStore.getState()\r\n                const existingPlan = state.plans[date] || { date, entries: [], totalCalories: 0 }\r\n                const updatedPlan = {\r\n                    ...existingPlan,\r\n                    entries: [...existingPlan.entries, newEntry]\r\n                }\r\n\r\n                set({\r\n                    plans: {\r\n                        ...state.plans,\r\n                        [date]: updatedPlan\r\n                    }\r\n                })\r\n\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'plans', date), updatedPlan)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            updatePlanEntry: async (date, updatedEntry) => {\r\n                const state = useAppStore.getState()\r\n                const plan = state.plans[date]\r\n                if (!plan) return\r\n\r\n                const updatedPlan = {\r\n                    ...plan,\r\n                    entries: plan.entries.map(e => e.id === updatedEntry.id ? updatedEntry : e)\r\n                }\r\n\r\n                set({\r\n                    plans: {\r\n                        ...state.plans,\r\n                        [date]: updatedPlan\r\n                    }\r\n                })\r\n\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'plans', date), updatedPlan)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            removePlanEntry: async (date, entryId) => {\r\n                const state = useAppStore.getState()\r\n                const plan = state.plans[date]\r\n                if (!plan) return\r\n\r\n                const updatedPlan = {\r\n                    ...plan,\r\n                    entries: plan.entries.filter(e => e.id !== entryId)\r\n                }\r\n\r\n                set({\r\n                    plans: {\r\n                        ...state.plans,\r\n                        [date]: updatedPlan\r\n                    }\r\n                })\r\n\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'plans', date), updatedPlan)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            addExerciseEntry: async (date, entry) => {\r\n                const newEntry: ExerciseEntry = {\r\n                    ...entry,\r\n                    id: crypto.randomUUID(),\r\n                    timestamp: Date.now()\r\n                }\r\n\r\n                const state = useAppStore.getState()\r\n                const existingLog = state.exerciseLogs[date] || { date, entries: [] }\r\n                const updatedLog: DayExerciseLog = {\r\n                    ...existingLog,\r\n                    entries: [...existingLog.entries, newEntry]\r\n                }\r\n\r\n                set({\r\n                    exerciseLogs: {\r\n                        ...state.exerciseLogs,\r\n                        [date]: updatedLog\r\n                    }\r\n                })\r\n\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'exercises', date), updatedLog)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore exercise sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            removeExerciseEntry: async (date, entryId) => {\r\n                const state = useAppStore.getState()\r\n                const log = state.exerciseLogs[date]\r\n                if (!log) return\r\n\r\n                const updatedLog: DayExerciseLog = {\r\n                    ...log,\r\n                    entries: log.entries.filter(e => e.id !== entryId)\r\n                }\r\n\r\n                set({\r\n                    exerciseLogs: {\r\n                        ...state.exerciseLogs,\r\n                        [date]: updatedLog\r\n                    }\r\n                })\r\n\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'exercises', date), updatedLog)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore exercise sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            syncWithFirestore: async () => {\r\n                const state = useAppStore.getState()\r\n                if (!state.user.isAuthenticated || !state.user.uid) return\r\n\r\n                try {\r\n                    // 1. Fetch Profile\r\n                    const userDoc = await getDoc(doc(db, 'users', state.user.uid!))\r\n                    if (userDoc.exists()) {\r\n                        set({ user: { ...state.user, ...userDoc.data() } as UserProfile })\r\n                    }\r\n\r\n                    // 2. Fetch Logs\r\n                    const logsColl = collection(db, 'users', state.user.uid!, 'logs')\r\n                    const logsSnap = await getDocs(logsColl)\r\n                    const fetchedLogs: Record<string, DayLog> = {}\r\n                    logsSnap.forEach(doc => {\r\n                        fetchedLogs[doc.id] = doc.data() as DayLog\r\n                    })\r\n\r\n                    // 3. Fetch Plans\r\n                    const plansColl = collection(db, 'users', state.user.uid!, 'plans')\r\n                    const plansSnap = await getDocs(plansColl)\r\n                    const fetchedPlans: Record<string, DayPlan> = {}\r\n                    plansSnap.forEach(planDoc => {\r\n                        fetchedPlans[planDoc.id] = planDoc.data() as DayPlan\r\n                    })\r\n\r\n                    // 4. Fetch Exercises\r\n                    const exercisesColl = collection(db, 'users', state.user.uid!, 'exercises')\r\n                    const exercisesSnap = await getDocs(exercisesColl)\r\n                    const fetchedExercises: Record<string, DayExerciseLog> = {}\r\n                    exercisesSnap.forEach(exerciseDoc => {\r\n                        fetchedExercises[exerciseDoc.id] = exerciseDoc.data() as DayExerciseLog\r\n                    })\r\n\r\n                    // 5. Fetch Reminders\r\n                    const remindersColl = collection(db, 'users', state.user.uid!, 'reminders')\r\n                    const remindersSnap = await getDocs(remindersColl)\r\n                    const fetchedReminders: Reminder[] = []\r\n                    remindersSnap.forEach(reminderDoc => {\r\n                        fetchedReminders.push({ ...reminderDoc.data(), id: reminderDoc.id } as Reminder)\r\n                    })\r\n\r\n                    set({\r\n                        logs: { ...state.logs, ...fetchedLogs },\r\n                        plans: { ...state.plans, ...fetchedPlans },\r\n                        exerciseLogs: { ...state.exerciseLogs, ...fetchedExercises },\r\n                        reminders: fetchedReminders,\r\n                        lastSyncedAt: new Date().toISOString()\r\n                    })\r\n\r\n                    // 6. Fetch Weight History\r\n                    const weightColl = collection(db, 'users', state.user.uid!, 'weightHistory')\r\n                    const weightSnap = await getDocs(weightColl)\r\n                    const fetchedWeight: WeightEntry[] = []\r\n                    weightSnap.forEach(doc => {\r\n                        fetchedWeight.push({ ...doc.data(), date: doc.id } as WeightEntry)\r\n                    })\r\n                    // Sort by timestamp\r\n                    fetchedWeight.sort((a, b) => a.timestamp - b.timestamp)\r\n                    set({ weightHistory: fetchedWeight })\r\n\r\n                    // 7. Fetch Global Shared API Key (Placeholder - functionality removed to prevent console warnings)\r\n                    try {\r\n                        // Shared API key fetching logic removed as per Task 1.4\r\n                    } catch (e) {\r\n                        // Silent fail for shared key\r\n                    }\r\n                } catch (e) {\r\n                    console.error(\"Firestore hydration error:\", e)\r\n                }\r\n            },\r\n\r\n            loadRecipeBook: async () => {\r\n                const state = useAppStore.getState()\r\n                if (!state.user.isAuthenticated || !state.user.uid) return\r\n                try {\r\n                    // Start fetching\r\n                    const recipes = await firestoreGetRecipes(state.user.uid!)\r\n                    set({ recipeBook: recipes })\r\n                } catch (error) {\r\n                    console.error(\"Failed to load recipe book\", error)\r\n                }\r\n            },\r\n\r\n            addToRecipeBook: async (item) => {\r\n                const state = useAppStore.getState()\r\n                if (!state.user.isAuthenticated || !state.user.uid) {\r\n                    // Local only fall back? or force auth\r\n                    return\r\n                }\r\n\r\n                try {\r\n                    // Optimistic update?\r\n                    // For now, wait for server\r\n                    const id = await firestoreAddRecipe(state.user.uid!, item)\r\n                    const newItem: RecipeBookItem = { ...item, id: id, addedAt: Date.now() }\r\n\r\n                    set(state => ({\r\n                        recipeBook: [newItem, ...state.recipeBook]\r\n                    }))\r\n                } catch (error) {\r\n                    console.error(\"Failed to add to recipe book\", error)\r\n                    throw error\r\n                }\r\n            },\r\n\r\n            removeFromRecipeBook: async (id) => {\r\n                const state = useAppStore.getState()\r\n                if (!state.user.isAuthenticated || !state.user.uid) return\r\n\r\n                try {\r\n                    await firestoreRemoveRecipe(state.user.uid!, id)\r\n                    set(state => ({\r\n                        recipeBook: state.recipeBook.filter(i => i.id !== id)\r\n                    }))\r\n                } catch (error) {\r\n                    console.error(\"Failed to remove from recipe book\", error)\r\n                    throw error\r\n                }\r\n            },\r\n\r\n\r\n\r\n\r\n            addReminder: async (reminderData) => {\r\n                const state = useAppStore.getState()\r\n                if (!state.user.isAuthenticated || !state.user.uid) return\r\n\r\n                const newReminder: Reminder = {\r\n                    ...reminderData,\r\n                    id: crypto.randomUUID(),\r\n                    createdAt: Date.now()\r\n                }\r\n\r\n                set(state => ({ reminders: [...state.reminders, newReminder] }))\r\n\r\n                try {\r\n                    const docRef = await addDoc(collection(db, 'users', state.user.uid!, 'reminders'), {\r\n                        ...newReminder\r\n                    })\r\n                    set(state => ({\r\n                        reminders: state.reminders.map(r => r.id === newReminder.id ? { ...r, id: docRef.id } : r)\r\n                    }))\r\n                } catch (e) {\r\n                    console.error(\"Failed to add reminder\", e)\r\n                }\r\n            },\r\n\r\n            removeReminder: async (id) => {\r\n                const state = useAppStore.getState()\r\n                if (!state.user.isAuthenticated || !state.user.uid) return\r\n\r\n                set(state => ({ reminders: state.reminders.filter(r => r.id !== id) }))\r\n\r\n                try {\r\n                    await deleteDoc(doc(db, 'users', state.user.uid!, 'reminders', id))\r\n                } catch (e) {\r\n                    console.error(\"Failed to remove reminder\", e)\r\n                }\r\n            },\r\n\r\n            clearAllReminders: async () => {\r\n                const state = useAppStore.getState()\r\n                if (!state.user.isAuthenticated || !state.user.uid) return\r\n\r\n                const ids = state.reminders.map(r => r.id)\r\n                set({ reminders: [] })\r\n                try {\r\n                    await Promise.all(ids.map(id => deleteDoc(doc(db, 'users', state.user.uid!, 'reminders', id))))\r\n                } catch (e) {\r\n                    console.error(\"Failed to clear reminders\", e)\r\n                }\r\n            },\r\n\r\n            updateWaterIntake: async (date, amount) => {\r\n                const state = useAppStore.getState()\r\n                const existingLog = state.logs[date] || { date, entries: [], waterIntake: 0 }\r\n                const updatedLog = {\r\n                    ...existingLog,\r\n                    waterIntake: amount\r\n                }\r\n\r\n                set({\r\n                    logs: {\r\n                        ...state.logs,\r\n                        [date]: updatedLog\r\n                    }\r\n                })\r\n\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'logs', date), updatedLog)\r\n                    } catch (e) {\r\n                        console.error(\"Firestore water sync error:\", e)\r\n                    }\r\n                }\r\n            },\r\n\r\n            logWeight: async (weight) => {\r\n                const date = new Date().toISOString().split('T')[0]\r\n                const timestamp = Date.now()\r\n                const newEntry: WeightEntry = { date, weight, timestamp }\r\n\r\n                const state = useAppStore.getState()\r\n                set(state => {\r\n                    const filtered = state.weightHistory.filter(w => w.date !== date)\r\n                    const updatedHistory = [...filtered, newEntry].sort((a, b) => a.timestamp - b.timestamp)\r\n\r\n                    return {\r\n                        weightHistory: updatedHistory,\r\n                        user: { ...state.user, weight }\r\n                    }\r\n                })\r\n\r\n                if (state.user.isAuthenticated && state.user.uid) {\r\n                    try {\r\n                        // Update history\r\n                        await setDoc(doc(db, 'users', state.user.uid!, 'weightHistory', date), newEntry)\r\n                        // Update user profile weight\r\n                        await setDoc(doc(db, 'users', state.user.uid!), { weight }, { merge: true })\r\n                    } catch (e) {\r\n                        console.error(\"Failed to log weight to Firestore\", e)\r\n                    }\r\n                }\r\n            },\r\n        }),\r\n        {\r\n            name: 'nutri-track-storage-v2',\r\n\r\n            storage: createJSONStorage(() => localStorage),\r\n        }\r\n    )\r\n)\r\n\r\n// Initialize Firebase Auth listener\r\nonAuthStateChanged(auth, async (firebaseUser) => {\r\n    if (firebaseUser) {\r\n        await useAppStore.getState().setUser({\r\n            isAuthenticated: true,\r\n            uid: firebaseUser.uid,\r\n            email: firebaseUser.email || '',\r\n            name: firebaseUser.displayName || 'User'\r\n        })\r\n        // Trigger Cloud Sync\r\n        await useAppStore.getState().syncWithFirestore()\r\n        await useAppStore.getState().loadRecipeBook()\r\n\r\n    } else {\r\n        useAppStore.getState().setUser({\r\n            isAuthenticated: false,\r\n            email: '',\r\n            name: 'Guest'\r\n        })\r\n    }\r\n})\r\n\r\n","usedDeprecatedRules":[]}]